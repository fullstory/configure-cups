#!/bin/bash
# cupsconfig - Start and configure cups
# (C) Klaus Knopper Jun 2001

PATH="/bin:/sbin:/usr/bin:/usr/sbin"
export PATH

HPLIP="$(pidof hpiod)"
if [ -z "$HPLIP" ]; then
	[ -x /etc/init.d/hplip ] && kanotix-su /etc/init.d/hplip start
fi

CUPSPID="$(pidof cupsd)"
if [ -z "$CUPSPID" ]; then
	[ -x /etc/init.d/cupsys ] && kanotix-su /etc/init.d/cupsys start
	sleep 4
fi

error=1
for i in 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2; do
	sleep $i
	# wget -q -O /dev/null http://127.0.0.1:631/
	lpstat -r >/dev/null 2>&1
	error="$?"
	[ "$error" = "0" ] && break
done

if [ "$error" = "0" ]; then
	if sudo kcmshell --nocrashhandler printers; then
		sudo update-rc.d -f cupsys defaults
	else
		kcmshell --nocrashhandler printers
	fi
else 
	[ -f /etc/sysconfig/knoppix ] && . /etc/sysconfig/knoppix
	case "$LANG" in
		es*)
			exec xmessage 'Â¡No puedo arrancar el servidor CUPS!'
			;;
		*)
			exec xmessage 'Cannot start CUPS server!'
			;;
	esac
fi

